<!DOCTYPE html>
<html lang="ar" dir="rtl">
<!-- ... نفس محتوى الـ head والـ body ... -->
<script>
    let curS=1,curE='ar',audio=document.getElementById('audio-player'),audioData=null;
    let mediaRecorder, audioChunks=[], activeRecorder=null;

    // دالة لجلب البيانات مع مهلة زمنية
    async function fetchWithTimeout(resource, options = {}, timeout = 15000) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        const response = await fetch(resource, {
            ...options,
            signal: controller.signal  
        });
        clearTimeout(id);
        return response;
    }

    async function load(n, e) {
        const c = document.getElementById('content');
        c.innerHTML = '<div class="loading">جاري التحميل...</div>';
        try {
            // استخدام الدالة الجديدة مع مهلة زمنية
            const arRes = await fetchWithTimeout(`https://api.alquran.cloud/v1/surah/${n}`);
            const trRes = await fetchWithTimeout(`https://api.alquran.cloud/v1/surah/${n}/en.transliteration`);
            const reciter = document.getElementById('reciter').value;
            const audioResRes = await fetchWithTimeout(`https://api.alquran.cloud/v1/surah/${n}/${reciter}`);

            if (!arRes.ok || !trRes.ok || !audioResRes.ok) {
                throw new Error('فشل في جلب البيانات من الشبكة.');
            }

            const ar = await arRes.json();
            const tr = await trRes.json();
            audioData = (await audioResRes.json()).data.ayahs;
            
            let trans = null;
            if (e !== 'ar') {
                const transRes = await fetchWithTimeout(`https://api.alquran.cloud/v1/surah/${n}/${e}`);
                if (transRes.ok) {
                    trans = await transRes.json();
                }
            }
            show(ar.data, tr.data, trans ? trans.data : null);

        } catch (err) {
            if (err.name === 'AbortError') {
                c.innerHTML = '<div class="loading">استغرق الخادم وقتاً طويلاً للرد. يرجى تحديث الصفحة والمحاولة مرة أخرى.</div>';
            } else {
                c.innerHTML = '<div class="loading">خطأ في تحميل البيانات. يرجى التحقق من اتصالك بالإنترنت.</div>';
            }
            console.error("Error loading data:", err);
        }
    }

    // ... باقي دوال جافاسكريبت تبقى كما هي ...
    function show(ar,tr,trans){
        // ... (نفس الكود بدون تغيير)
    }
    window.playVerse = function(index){
        // ... (نفس الكود بدون تغيير)
    }
    // ... وهكذا
</script>
</body>
</html>

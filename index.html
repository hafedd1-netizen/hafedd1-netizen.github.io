<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ù†ØµØ© ØªØ­ÙÙŠØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</title>
<style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Traditional Arabic',Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);direction:rtl;min-height:100vh;padding:15px}
    .header{background:white;padding:20px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.2);margin-bottom:15px;text-align:center}
    h1{color:#667eea;font-size:28px;margin-bottom:5px}
    .subtitle{color:#666;font-size:15px;margin-bottom:10px}
    .main-container{display:flex;gap:15px;max-width:1600px;margin:0 auto}
    .controls-sidebar{width:320px;flex-shrink:0}
    .controls{background:white;padding:18px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.2);margin-bottom:15px}
    .section{margin-bottom:15px;padding-bottom:15px;border-bottom:1px solid #eee}
    .section:last-child{border-bottom:none;margin-bottom:0}
    .label{font-size:15px;color:#667eea;font-weight:bold;margin-bottom:8px;display:block}
    select{padding:8px 12px;font-size:14px;border:2px solid #667eea;border-radius:20px;background:white;color:#667eea;cursor:pointer;width:100%}
    .btn-row{display:flex;flex-wrap:wrap;gap:6px}
    button{padding:8px 15px;font-size:13px;border:2px solid #667eea;border-radius:18px;background:#667eea;color:white;cursor:pointer;transition:all 0.3s;font-weight:bold;flex:1;min-width:80px}
    button:hover{background:#764ba2;border-color:#764ba2;transform:translateY(-1px)}
    button:disabled{opacity:0.5;cursor:not-allowed}
    .lang-btn{background:white;color:#667eea;font-size:12px;min-width:60px}
    .lang-btn.active{background:#667eea;color:white}
    #reveal-btn{background:#28a745;border-color:#28a745}
    #reveal-btn:hover{background:#218838;border-color:#218838}
    #content{flex:1;background:white;padding:15px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.2);max-height:calc(100vh - 100px);overflow-y:auto}
    .title{text-align:center;color:#667eea;font-size:24px;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid #667eea}
    .verse{margin-bottom:5px;padding:10px;background:#f8f9ff;border-radius:8px;transition:all 0.4s;position:relative}
    .verse:hover{box-shadow:0 2px 8px rgba(102,126,234,0.15)}
    .verse.playing{background:#fff3cd;box-shadow:0 4px 12px rgba(255,215,0,0.4)}
    .verse-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .num{display:inline-block;background:#667eea;color:white;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:bold}
    .verse-controls{display:flex;gap:5px}
    .verse-btn{padding:5px 10px;font-size:12px;min-width:auto;border-radius:12px}
    .play-verse-btn{background:#ff6b6b;border-color:#ff6b6b}
    .repeat-verse-btn{background:#ffd93d;border-color:#ffd93d;color:#333}
    .record-verse-btn{background:#1a73e8;border-color:#1a73e8}
    .stop-record-btn{background:#ea4335;border-color:#ea4335}
    .arabic{font-size:24px;line-height:1.6;margin-bottom:6px;direction:rtl;text-align:right;color:#1a1a1a}
    .translit{font-size:15px;line-height:1.3;margin-bottom:3px;color:#555;font-style:italic;direction:ltr;text-align:left;font-family:Georgia,serif}
    .trans{font-size:15px;line-height:1.3;color:#333;padding:6px;background:white;border-left:3px solid #667eea;border-radius:4px;direction:ltr;text-align:left}
    .word{display:inline-block;padding:2px 4px;margin:1px;cursor:pointer;transition:all 0.3s;border-radius:3px}
    .word:hover{background:#fff3cd}
    .word.hidden{color:transparent;background:#ddd;user-select:none}
    .word.revealed{background:#d4edda!important;color:#155724!important}
    .user-playback{margin-top:10px;padding-top:10px;border-top:1px dashed #ccc}
    .user-playback audio{width:100%;margin-top:5px}
    .loading{text-align:center;padding:40px;font-size:20px;color:#667eea}
    @media (max-width:1024px){.main-container{flex-direction:column}.controls-sidebar{width:100%}#content{max-height:none}}
</style>
</head>
<body>

<div class="header">
    <h1>ğŸ“– Ù…Ù†ØµØ© ØªØ­ÙÙŠØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</h1>
    <p class="subtitle">Quran Memorization Platform</p>
   <a href="./teacher.html" style="display:inline-block;padding:8px 20px;background:#667eea;color:#fff;text-decoration:none;border-radius:15px;font-weight:bold;margin:8px 6px 0">
  Ø§Ù„Ù…Ø¹Ù„Ù‘Ù… Ø§Ù„Ø°ÙƒÙŠ
</a>
    <a href="learn.html" style="display:inline-block;padding:8px 20px;background:#28a745;color:white;text-decoration:none;border-radius:15px;font-size:14px;margin-top:10px">ğŸ“š Ø¯Ø±ÙˆØ³ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© / Arabic Lessons</a>
</div>

<div class="main-container">
    <div class="controls-sidebar">
        <div class="controls">
            <div class="section">
                <label class="label">Ø§Ù„Ø³ÙˆØ±Ø©</label>
                <select id="surah">
                    <option value="1">1-Ø§Ù„ÙØ§ØªØ­Ø©</option><option value="2">2-Ø§Ù„Ø¨Ù‚Ø±Ø©</option><option value="3">3-Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†</option><option value="4">4-Ø§Ù„Ù†Ø³Ø§Ø¡</option><option value="5">5-Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©</option><option value="6">6-Ø§Ù„Ø£Ù†Ø¹Ø§Ù…</option><option value="7">7-Ø§Ù„Ø£Ø¹Ø±Ø§Ù</option><option value="8">8-Ø§Ù„Ø£Ù†ÙØ§Ù„</option><option value="9">9-Ø§Ù„ØªÙˆØ¨Ø©</option><option value="10">10-ÙŠÙˆÙ†Ø³</option><option value="11">11-Ù‡ÙˆØ¯</option><option value="12">12-ÙŠÙˆØ³Ù</option><option value="13">13-Ø§Ù„Ø±Ø¹Ø¯</option><option value="14">14-Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…</option><option value="15">15-Ø§Ù„Ø­Ø¬Ø±</option><option value="16">16-Ø§Ù„Ù†Ø­Ù„</option><option value="17">17-Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡</option><option value="18">18-Ø§Ù„ÙƒÙ‡Ù</option><option value="19">19-Ù…Ø±ÙŠÙ…</option><option value="20">20-Ø·Ù‡</option><option value="21">21-Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡</option><option value="22">22-Ø§Ù„Ø­Ø¬</option><option value="23">23-Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†</option><option value="24">24-Ø§Ù„Ù†ÙˆØ±</option><option value="25">25-Ø§Ù„ÙØ±Ù‚Ø§Ù†</option><option value="26">26-Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡</option><option value="27">27-Ø§Ù„Ù†Ù…Ù„</option><option value="28">28-Ø§Ù„Ù‚ØµØµ</option><option value="29">29-Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª</option><option value="30">30-Ø§Ù„Ø±ÙˆÙ…</option><option value="31">31-Ù„Ù‚Ù…Ø§Ù†</option><option value="32">32-Ø§Ù„Ø³Ø¬Ø¯Ø©</option><option value="33">33-Ø§Ù„Ø£Ø­Ø²Ø§Ø¨</option><option value="34">34-Ø³Ø¨Ø£</option><option value="35">35-ÙØ§Ø·Ø±</option><option value="36">36-ÙŠØ³</option><option value="37">37-Ø§Ù„ØµØ§ÙØ§Øª</option><option value="38">38-Øµ</option><option value="39">39-Ø§Ù„Ø²Ù…Ø±</option><option value="40">40-ØºØ§ÙØ±</option><option value="41">41-ÙØµÙ„Øª</option><option value="42">42-Ø§Ù„Ø´ÙˆØ±Ù‰</option><option value="43">43-Ø§Ù„Ø²Ø®Ø±Ù</option><option value="44">44-Ø§Ù„Ø¯Ø®Ø§Ù†</option><option value="45">45-Ø§Ù„Ø¬Ø§Ø«ÙŠØ©</option><option value="46">46-Ø§Ù„Ø£Ø­Ù‚Ø§Ù</option><option value="47">47-Ù…Ø­Ù…Ø¯</option><option value="48">48-Ø§Ù„ÙØªØ­</option><option value="49">49-Ø§Ù„Ø­Ø¬Ø±Ø§Øª</option><option value="50">50-Ù‚</option><option value="51">51-Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª</option><option value="52">52-Ø§Ù„Ø·ÙˆØ±</option><option value="53">53-Ø§Ù„Ù†Ø¬Ù…</option><option value="54">54-Ø§Ù„Ù‚Ù…Ø±</option><option value="55">55-Ø§Ù„Ø±Ø­Ù…Ù†</option><option value="56">56-Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©</option><option value="57">57-Ø§Ù„Ø­Ø¯ÙŠØ¯</option><option value="58">58-Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©</option><option value="59">59-Ø§Ù„Ø­Ø´Ø±</option><option value="60">60-Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©</option><option value="61">61-Ø§Ù„ØµÙ</option><option value="62">62-Ø§Ù„Ø¬Ù…Ø¹Ø©</option><option value="63">63-Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†</option><option value="64">64-Ø§Ù„ØªØºØ§Ø¨Ù†</option><option value="65">65-Ø§Ù„Ø·Ù„Ø§Ù‚</option><option value="66">66-Ø§Ù„ØªØ­Ø±ÙŠÙ…</option><option value="67">67-Ø§Ù„Ù…Ù„Ùƒ</option><option value="68">68-Ø§Ù„Ù‚Ù„Ù…</option><option value="69">69-Ø§Ù„Ø­Ø§Ù‚Ø©</option><option value="70">70-Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬</option><option value="71">71-Ù†ÙˆØ­</option><option value="72">72-Ø§Ù„Ø¬Ù†</option><option value="73">73-Ø§Ù„Ù…Ø²Ù…Ù„</option><option value="74">74-Ø§Ù„Ù…Ø¯Ø«Ø±</option><option value="75">75-Ø§Ù„Ù‚ÙŠØ§Ù…Ø©</option><option value="76">76-Ø§Ù„Ø¥Ù†Ø³Ø§Ù†</option><option value="77">77-Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª</option><option value="78">78-Ø§Ù„Ù†Ø¨Ø£</option><option value="79">79-Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª</option><option value="80">80-Ø¹Ø¨Ø³</option><option value="81">81-Ø§Ù„ØªÙƒÙˆÙŠØ±</option><option value="82">82-Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±</option><option value="83">83-Ø§Ù„Ù…Ø·ÙÙÙŠÙ†</option><option value="84">84-Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚</option><option value="85">85-Ø§Ù„Ø¨Ø±ÙˆØ¬</option><option value="86">86-Ø§Ù„Ø·Ø§Ø±Ù‚</option><option value="87">87-Ø§Ù„Ø£Ø¹Ù„Ù‰</option><option value="88">88-Ø§Ù„ØºØ§Ø´ÙŠØ©</option><option value="89">89-Ø§Ù„ÙØ¬Ø±</option><option value="90">90-Ø§Ù„Ø¨Ù„Ø¯</option><option value="91">91-Ø§Ù„Ø´Ù…Ø³</option><option value="92">92-Ø§Ù„Ù„ÙŠÙ„</option><option value="93">93-Ø§Ù„Ø¶Ø­Ù‰</option><option value="94">94-Ø§Ù„Ø´Ø±Ø­</option><option value="95">95-Ø§Ù„ØªÙŠÙ†</option><option value="96">96-Ø§Ù„Ø¹Ù„Ù‚</option><option value="97">97-Ø§Ù„Ù‚Ø¯Ø±</option><option value="98">98-Ø§Ù„Ø¨ÙŠÙ†Ø©</option><option value="99">99-Ø§Ù„Ø²Ù„Ø²Ù„Ø©</option><option value="100">100-Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª</option><option value="101">101-Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©</option><option value="102">102-Ø§Ù„ØªÙƒØ§Ø«Ø±</option><option value="103">103-Ø§Ù„Ø¹ØµØ±</option><option value="104">104-Ø§Ù„Ù‡Ù…Ø²Ø©</option><option value="105">105-Ø§Ù„ÙÙŠÙ„</option><option value="106">106-Ù‚Ø±ÙŠØ´</option><option value="107">107-Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†</option><option value="108">108-Ø§Ù„ÙƒÙˆØ«Ø±</option><option value="109">109-Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†</option><option value="110">110-Ø§Ù„Ù†ØµØ±</option><option value="111">111-Ø§Ù„Ù…Ø³Ø¯</option><option value="112">112-Ø§Ù„Ø¥Ø®Ù„Ø§Øµ</option><option value="113">113-Ø§Ù„ÙÙ„Ù‚</option><option value="114">114-Ø§Ù„Ù†Ø§Ø³</option>
                </select>
            </div>
            <div class="section">
                <label class="label">Ø§Ù„Ù‚Ø§Ø±Ø¦</label>
                <select id="reciter">
                    <option value="ar.alafasy">Ù…Ø´Ø§Ø±ÙŠ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ</option><option value="ar.abdulbasitmurattal">Ø¹Ø¨Ø¯Ø§Ù„Ø¨Ø§Ø³Ø·</option><option value="ar.abdurrahmaansudais">Ø§Ù„Ø³Ø¯ÙŠØ³</option><option value="ar.shaatree">Ø§Ù„Ø´Ø§Ø·Ø±ÙŠ</option><option value="ar.husary">Ø§Ù„Ø­ØµØ±ÙŠ</option><option value="ar.minshawi">Ø§Ù„Ù…Ù†Ø´Ø§ÙˆÙŠ</option>
                </select>
            </div>
            <div class="section">
                <label class="label">Ø§Ù„Ù„ØºØ©</label>
                <div class="btn-row">
                    <button class="lang-btn active" data-ed="ar">Ø¹</button><button class="lang-btn" data-ed="en.asad">EN</button><button class="lang-btn" data-ed="fr.hamidullah">FR</button><button class="lang-btn" data-ed="es.cortes">ES</button><button class="lang-btn" data-ed="de.bubenheim">DE</button><button class="lang-btn" data-ed="it.piccardo">IT</button>
                </div>
            </div>
            <div class="section">
                <label class="label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ø®ÙØ§Ø¡</label>
                <select id="hide-percentage">
                    <option value="10">10%</option><option value="20">20%</option><option value="30">30%</option><option value="40">40%</option><option value="50" selected>50%</option><option value="60">60%</option><option value="70">70%</option><option value="80">80%</option><option value="90">90%</option><option value="100">100%</option>
                </select>
            </div>
            <div class="section">
                <div class="btn-row">
                    <button id="hide-btn">ğŸ¯ Ø¥Ø®ÙØ§Ø¡</button><button id="reveal-btn">âœ“ Ø¥Ø¸Ù‡Ø§Ø±</button>
                </div>
            </div>
        </div>
    </div>
    <div id="content">
        <div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
</div>
<audio id="audio-player" style="display:none;"></audio>

<script>
    let curS=1,curE='ar',audio=document.getElementById('audio-player'),audioData=null;
    let mediaRecorder, audioChunks=[], activeRecorder=null;

    async function fetchWithTimeout(resource, options = {}, timeout = 20000) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        const response = await fetch(resource, { ...options, signal: controller.signal });
        clearTimeout(id);
        return response;
    }

    async function load(n,e){
        const c=document.getElementById('content');
        c.innerHTML='<div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
        try{
            const arRes = await fetchWithTimeout(`https://api.alquran.cloud/v1/surah/${n}`);
            if (!arRes.ok) throw new Error(`Arabic text fetch failed: ${arRes.statusText}`);
            const ar = await arRes.json();

            const trRes = await fetchWithTimeout(`https://api.alquran.cloud/v1/surah/${n}/en.transliteration`);
            if (!trRes.ok) throw new Error(`Transliteration fetch failed: ${trRes.statusText}`);
            const tr = await trRes.json();

            const reciter=document.getElementById('reciter').value;
            const audioRes = await fetchWithTimeout(`https://api.alquran.cloud/v1/surah/${n}/${reciter}`);
            if (!audioRes.ok) throw new Error(`Audio fetch failed: ${audioRes.statusText}`);
            audioData=(await audioRes.json()).data.ayahs;
            
            let trans=null;
            if(e!=='ar'){
                const transRes = await fetchWithTimeout(`https://api.alquran.cloud/v1/surah/${n}/${e}`);
                if (transRes.ok) trans = await transRes.json();
            }
            show(ar.data,tr.data,trans?trans.data:null);
        }catch(err){
            let errorMsg = 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.';
            if (err.name === 'AbortError') {
                errorMsg = 'Ø§Ø³ØªØºØ±Ù‚ Ø§Ù„Ø®Ø§Ø¯Ù… ÙˆÙ‚ØªØ§Ù‹ Ø·ÙˆÙŠÙ„Ø§Ù‹ Ù„Ù„Ø±Ø¯. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
            }
            c.innerHTML=`<div class="loading">${errorMsg}</div>`;
            console.error("Error loading data:", err);
        }
    }
    
    function show(ar,tr,trans){
        const c=document.getElementById('content');
        let h=`<h2 class="title">${ar.name} - ${ar.englishName}</h2>`;
        ar.ayahs.forEach((a,vi)=>{
            const arabicWords = a.text.split(' ');
            const translitWords = tr.ayahs[vi] ? tr.ayahs[vi].text.split(' ') : [];
            
            h+=`<div class="verse" data-ayah="${vi}">`;
            h+=`<div class="verse-header"><div class="num">${a.numberInSurah}</div><div class="verse-controls">`;
            h+=`<button class="verse-btn play-verse-btn" onclick="playVerse(${vi})">â–¶</button>`;
            h+=`<button class="verse-btn repeat-verse-btn" onclick="repeatVerse(${vi})">ğŸ”</button>`;
            h+=`<button class="verse-btn record-verse-btn" id="record-${vi}" onclick="startRecording(this, ${vi})">ğŸ¤</button>`;
            h+=`<button class="verse-btn stop-record-btn" id="stop-${vi}" onclick="stopRecording(this, ${vi})" style="display:none;">â¹ï¸</button>`;
            h+=`</div></div>`;
            
            h+=`<div class="arabic">`;
            arabicWords.forEach((w,wi)=>{
                h+=`<span class="word aw" data-v="${vi}" data-w="${wi}">${w} </span>`;
            });
            h+=`</div>`;
            
            if(translitWords.length > 0){
                h+=`<div class="translit">`;
                translitWords.forEach((w,wi)=>{
                    h+=`<span class="word tw" data-v="${vi}" data-w="${wi}">${w} </span>`;
                });
                h+=`</div>`;
            }
            
            if(trans&&trans.ayahs[vi]){
                h+=`<div class="trans">${trans.ayahs[vi].text}</div>`;
            }
            
            h+=`<div class="user-playback" id="playback-${vi}" style="display:none;"><p style="font-size:14px; margin-top:10px; font-weight:bold;">ØªØ³Ø¬ÙŠÙ„Ùƒ:</p><audio controls></audio></div>`;
            h+=`</div>`;
        });
        c.innerHTML=h;
        
        document.querySelectorAll('.word').forEach(w=>{
            w.onclick=function(){
                if(this.classList.contains('hidden')){
                    this.classList.remove('hidden');
                    this.classList.add('revealed');
                    const v=this.dataset.v, wi=this.dataset.w;
                    const otherClass = this.classList.contains('aw') ? 'tw' : 'aw';
                    const paired = document.querySelector(`.${otherClass}[data-v="${v}"][data-w="${wi}"]`);
                    if(paired){
                        paired.classList.remove('hidden');
                        paired.classList.add('revealed');
                    }
                }
            }
        });
    }
    
    window.playVerse=function(index){
        document.querySelectorAll('.verse').forEach(v=>v.classList.remove('playing'));
        const verse=document.querySelector(`.verse[data-ayah="${index}"]`);
        if(verse){
            verse.classList.add('playing');
            verse.scrollIntoView({behavior:'smooth',block:'center'});
        }
        if(audioData&&audioData[index]){
            audio.src=audioData[index].audio;
            audio.play();
            audio.onended=()=>{if(verse)verse.classList.remove('playing');};
        }
    };
    
    window.repeatVerse=function(index){playVerse(index);};

    window.startRecording = async function(btn, verseIndex) {
        if(mediaRecorder && mediaRecorder.state === 'recording') { 
            alert('Ù‡Ù†Ø§Ùƒ ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ Ø¥ÙŠÙ‚Ø§ÙÙ‡ Ø£ÙˆÙ„Ø§Ù‹.'); 
            return; 
        }
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            
            const stopBtn = document.getElementById(`stop-${verseIndex}`);
            btn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            
            const playbackDiv = document.getElementById(`playback-${verseIndex}`);
            if(playbackDiv) playbackDiv.style.display = 'none';
            
            audioChunks = [];
            mediaRecorder.start();
            
            mediaRecorder.ondataavailable = event => { audioChunks.push(event.data); };
            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);
                if(playbackDiv) {
                    const userAudio = playbackDiv.querySelector('audio');
                    userAudio.src = audioUrl;
                    playbackDiv.style.display = 'block';
                }
                stream.getTracks().forEach(track => track.stop());
            };
        } catch(err) { 
            alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù‡ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.'); 
            console.error(err); 
        }
    };
    
    window.stopRecording = function(btn, verseIndex) {
        if(mediaRecorder && mediaRecorder.state === 'recording') { 
            mediaRecorder.stop(); 
        }
        const recordBtn = document.getElementById(`record-${verseIndex}`);
        btn.style.display = 'none';
        recordBtn.style.display = 'inline-block';
    };
    
    document.querySelectorAll('.lang-btn').forEach(b=>{
        b.onclick=function(){
            document.querySelectorAll('.lang-btn').forEach(x=>x.classList.remove('active'));
            this.classList.add('active');
            curE=this.dataset.ed;
            load(curS,curE);
        };
    });
    
    document.getElementById('surah').onchange=function(){
        curS=this.value;
        audio.pause();
        load(curS,curE);
    };
    
    document.getElementById('reciter').onchange=function(){
        audio.pause();
        load(curS,curE);
    };
    
    document.getElementById('hide-btn').onclick=function(){
        const p=parseInt(document.getElementById('hide-percentage').value);
        
        document.querySelectorAll('.word').forEach(w=>{
            w.classList.remove('revealed');
            w.classList.remove('hidden');
        });
        
        const arabicWords = Array.from(document.querySelectorAll('.aw'));
        const hideCount = Math.floor(arabicWords.length * (p/100));
        
        arabicWords.sort(() => Math.random() - 0.5);
        
        for(let i = 0; i < hideCount; i++){
            const arabicWord = arabicWords[i];
            arabicWord.classList.add('hidden');
            
            const v = arabicWord.dataset.v;
            const wi = arabicWord.dataset.w;
            const translitWord = document.querySelector(`.tw[data-v="${v}"][data-w="${wi}"]`);
            
            if(translitWord) {
                translitWord.classList.add('hidden');
            }
        }
    };
    
    document.getElementById('reveal-btn').onclick=function(){
        document.querySelectorAll('.word').forEach(w=>{
            w.classList.remove('hidden');
            w.classList.remove('revealed');
        });
    };
    
    load(1,'ar');
</script>
</body>
</html>

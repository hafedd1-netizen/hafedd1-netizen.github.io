<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>منصة تحفيظ القرآن التفاعلية</title>
<style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Traditional Arabic',Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);direction:rtl;min-height:100vh;padding:15px}
    .header{background:white;padding:20px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.2);margin-bottom:15px;text-align:center}
    h1{color:#667eea;font-size:28px;margin-bottom:5px}
    .subtitle{color:#666;font-size:15px;margin-bottom:10px}
    .main-container{display:flex;gap:15px;max-width:1600px;margin:0 auto}
    .controls-sidebar{width:320px;flex-shrink:0}
    .controls{background:white;padding:18px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.2);margin-bottom:15px}
    .section{margin-bottom:15px;padding-bottom:15px;border-bottom:1px solid #eee}
    .section:last-child{border-bottom:none;margin-bottom:0}
    .label{font-size:15px;color:#667eea;font-weight:bold;margin-bottom:8px;display:block}
    select{padding:8px 12px;font-size:14px;border:2px solid #667eea;border-radius:20px;background:white;color:#667eea;cursor:pointer;width:100%}
    .btn-row{display:flex;flex-wrap:wrap;gap:6px}
    button{padding:8px 15px;font-size:13px;border:2px solid #667eea;border-radius:18px;background:#667eea;color:white;cursor:pointer;transition:all 0.3s;font-weight:bold;flex:1;min-width:80px}
    button:hover{background:#764ba2;border-color:#764ba2;transform:translateY(-1px)}
    button:disabled{opacity:0.5;cursor:not-allowed}
    .lang-btn{background:white;color:#667eea;font-size:12px;min-width:60px}
    .lang-btn.active{background:#667eea;color:white}
    #reveal-btn{background:#28a745;border-color:#28a745}
    #reveal-btn:hover{background:#218838;border-color:#218838}
    #content{flex:1;background:white;padding:15px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.2);max-height:calc(100vh - 100px);overflow-y:auto}
    .title{text-align:center;color:#667eea;font-size:24px;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid #667eea}
    .verse{margin-bottom:5px;padding:10px;background:#f8f9ff;border-radius:8px;transition:all 0.4s;position:relative}
    .verse:hover{box-shadow:0 2px 8px rgba(102,126,234,0.15)}
    .verse.playing{background:#fff3cd;box-shadow:0 4px 12px rgba(255,215,0,0.4)}
    .verse-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .num{display:inline-block;background:#667eea;color:white;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:bold}
    .verse-controls{display:flex;gap:5px}
    .verse-btn{padding:5px 10px;font-size:12px;min-width:auto;border-radius:12px}
    .play-verse-btn{background:#ff6b6b;border-color:#ff6b6b}
    .repeat-verse-btn{background:#ffd93d;border-color:#ffd93d;color:#333}
    .record-verse-btn{background:#1a73e8;border-color:#1a73e8}
    .stop-record-btn{background:#ea4335;border-color:#ea4335}
    .arabic{font-size:24px;line-height:1.6;margin-bottom:6px;direction:rtl;text-align:right;color:#1a1a1a}
    .translit{font-size:15px;line-height:1.3;margin-bottom:3px;color:#555;font-style:italic;direction:ltr;text-align:left;font-family:Georgia,serif}
    .trans{font-size:15px;line-height:1.3;color:#333;padding:6px;background:white;border-left:3px solid #667eea;border-radius:4px;direction:ltr;text-align:left}
    .word{display:inline-block;padding:2px 4px;margin:1px;cursor:pointer;transition:all 0.3s;border-radius:3px}
    .word:hover{background:#fff3cd}
    .word.hidden{color:transparent;background:#ddd;user-select:none}
    .word.revealed{background:#d4edda!important;color:#155724!important}
    .user-playback{margin-top:10px;padding-top:10px;border-top:1px dashed #ccc}
    .user-playback audio{width:100%;margin-top:5px}
    .loading{text-align:center;padding:40px;font-size:20px;color:#667eea}
    @media (max-width:1024px){.main-container{flex-direction:column}.controls-sidebar{width:100%}#content{max-height:none}}
</style>
</head>
<body>

<div class="header">
<h1>📖 منصة تحفيظ القرآن الكريم</h1>
<p class="subtitle">Quran Memorization Platform</p>
<a href="lessons.html" style="display:inline-block;padding:8px 20px;background:#28a745;color:white;text-decoration:none;border-radius:15px;font-size:14px">📚 دروس اللغة العربية</a>
</div>

<div class="main-container">
    <div class="controls-sidebar">
        <!-- ... نفس محتوى لوحة التحكم ... -->
        <div class="controls">
            <div class="section"><label class="label">السورة</label><select id="surah"><option value="1">1-الفاتحة</option><option value="2">2-البقرة</option><!-- ... باقي السور ... --><option value="114">114-الناس</option></select></div>
            <div class="section"><label class="label">القارئ</label><select id="reciter"><option value="ar.alafasy">مشاري العفاسي</option><option value="ar.abdulbasitmurattal">عبدالباسط</option><option value="ar.abdurrahmaansudais">السديس</option><option value="ar.shaatree">الشاطري</option><option value="ar.husary">الحصري</option><option value="ar.minshawi">المنشاوي</option></select></div>
            <div class="section"><label class="label">اللغة</label><div class="btn-row"><button class="lang-btn active" data-ed="ar">ع</button><button class="lang-btn" data-ed="en.asad">EN</button><button class="lang-btn" data-ed="fr.hamidullah">FR</button><button class="lang-btn" data-ed="es.cortes">ES</button><button class="lang-btn" data-ed="de.bubenheim">DE</button><button class="lang-btn" data-ed="it.piccardo">IT</button></div></div>
            <div class="section"><label class="label">النسبة</label><select id="hide-percentage"><option value="10">10%</option><option value="50" selected>50%</option><option value="100">100%</option></select></div>
            <div class="section"><div class="btn-row"><button id="hide-btn">🎯 إخفاء</button><button id="reveal-btn">✓ إظهار</button></div></div>
        </div>
    </div>
    <div id="content">
        <div class="loading">جاري التحميل...</div>
    </div>
</div>
<audio id="audio-player" style="display:none;"></audio>

<script>
    let curS=1,curE='ar',audio=document.getElementById('audio-player'),audioData=null;
    let mediaRecorder, audioChunks=[], activeRecorder=null;

    async function load(n,e){
        const c=document.getElementById('content');
        c.innerHTML='<div class="loading">جاري التحميل...</div>';
        try{
            const ar=await fetch(`https://api.alquran.cloud/v1/surah/${n}`).then(r=>r.json());
            const tr=await fetch(`https://api.alquran.cloud/v1/surah/${n}/en.transliteration`).then(r=>r.json());
            const reciter=document.getElementById('reciter').value;
            const audioRes=await fetch(`https://api.alquran.cloud/v1/surah/${n}/${reciter}`).then(r=>r.json());
            audioData=audioRes.data.ayahs;
            let trans=null;
            if(e!=='ar')trans=await fetch(`https://api.alquran.cloud/v1/surah/${n}/${e}`).then(r=>r.json());
            show(ar.data,tr.data,trans?trans.data:null);
        }catch(err){c.innerHTML='<div class="loading">خطأ في تحميل البيانات.</div>';}
    }
    
    function show(ar,tr,trans){
        const c=document.getElementById('content');
        let h=`<h2 class="title">${ar.name} - ${ar.englishName}</h2>`;
        ar.ayahs.forEach((a,vi)=>{
            h+=`<div class="verse" data-ayah="${vi}">`;
            h+=`<div class="verse-header"><div class="num">${a.numberInSurah}</div><div class="verse-controls">`;
            h+=`<button class="verse-btn play-verse-btn" onclick="playVerse(${vi})">▶</button>`;
            h+=`<button class="verse-btn repeat-verse-btn" onclick="repeatVerse(${vi})">🔁</button>`;
            h+=`<button class="verse-btn record-verse-btn" onclick="startRecording(this, ${vi})">🎤</button>`;
            h+=`<button class="verse-btn stop-record-btn" onclick="stopRecording(this, ${vi})" style="display:none;">⏹️</button>`;
            h+=`</div></div>`;
            h+=`<div class="arabic">`;
            a.text.split(' ').forEach((w,wi)=>{h+=`<span class="word aw" data-v="${vi}" data-w="${wi}">${w} </span>`;});
            h+=`</div>`;
            if(tr.ayahs[vi]){h+=`<div class="translit">${tr.ayahs[vi].text}</div>`;}
            if(trans&&trans.ayahs[vi]){h+=`<div class="trans">${trans.ayahs[vi].text}</div>`;}
            h+=`<div class="user-playback" id="playback-${vi}" style="display:none;"><p style="font-size:14px; margin-top:10px; font-weight:bold;">تسجيلك:</p><audio controls></audio></div>`;
            h+=`</div>`;
        });
        c.innerHTML=h;
        document.querySelectorAll('.word').forEach(w=>{w.onclick=function(){if(this.classList.contains('hidden')){this.classList.remove('hidden');this.classList.add('revealed');const v=this.dataset.v,wi=this.dataset.w;const p=document.querySelector(`.${this.classList.contains('aw')?'tw':'aw'}[data-v="${v}"][data-w="${wi}"]`);if(p){p.classList.remove('hidden');p.classList.add('revealed');}}}});
    }
    
    window.playVerse=function(index){
        document.querySelectorAll('.verse').forEach(v=>v.classList.remove('playing'));
        const verse=document.querySelector(`.verse[data-ayah="${index}"]`);
        if(verse){verse.classList.add('playing');verse.scrollIntoView({behavior:'smooth',block:'center'});}
        if(audioData&&audioData[index]){audio.src=audioData[index].audio;audio.play();audio.onended=()=>{verse.classList.remove('playing');};}
    };
    
    window.repeatVerse=function(index){playVerse(index);};

    // --- دوال التسجيل الصوتي ---
    window.startRecording = async function(btn, verseIndex) {
        if(mediaRecorder && mediaRecorder.state === 'recording') { alert('هناك تسجيل قيد التشغيل بالفعل. يرجى إيقافه أولاً.'); return; }
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            
            const stopBtn = btn.nextElementSibling;
            btn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            activeRecorder = { verseIndex, btn };
            
            const playbackDiv = document.getElementById(`playback-${verseIndex}`);
            if(playbackDiv) playbackDiv.style.display = 'none';
            
            audioChunks = [];
            mediaRecorder.start();
            
            mediaRecorder.ondataavailable = event => { audioChunks.push(event.data); };
            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);
                if(playbackDiv) {
                    const userAudio = playbackDiv.querySelector('audio');
                    userAudio.src = audioUrl;
                    playbackDiv.style.display = 'block';
                }
                stream.getTracks().forEach(track => track.stop());
            };
        } catch(err) { alert('خطأ: لم يتم منح إذن الوصول إلى الميكروفون.'); }
    };
    
    window.stopRecording = function(btn, verseIndex) {
        if(mediaRecorder && mediaRecorder.state === 'recording') { mediaRecorder.stop(); }
        const recordBtn = btn.previousElementSibling;
        btn.style.display = 'none';
        recordBtn.style.display = 'inline-block';
        activeRecorder = null;
    };
    // --- نهاية دوال التسجيل ---
    
    document.querySelectorAll('.lang-btn').forEach(b=>{b.onclick=function(){document.querySelectorAll('.lang-btn').forEach(x=>x.classList.remove('active'));this.classList.add('active');curE=this.dataset.ed;load(curS,curE);};});
    document.getElementById('surah').onchange=function(){curS=this.value;audio.pause();load(curS,curE);};
    document.getElementById('reciter').onchange=function(){audio.pause();load(curS,curE);};
    document.getElementById('hide-btn').onclick=function(){const p=parseInt(document.getElementById('hide-percentage').value);const all=document.querySelectorAll('.word');all.forEach(w=>{w.classList.remove('revealed');w.classList.remove('hidden');});const aw=Array.from(document.querySelectorAll('.aw'));const hide=Math.floor(aw.length*(p/100));aw.sort(()=>Math.random()-0.5);for(let i=0;i<hide;i++){aw[i].classList.add('hidden');const v=aw[i].dataset.v,wi=aw[i].dataset.w;const tw=document.querySelector(`.tw[data-v="${v}"][data-w="${wi}"]`);if(tw)tw.classList.add('hidden');}};
    document.getElementById('reveal-btn').onclick=function(){document.querySelectorAll('.word').forEach(w=>{w.classList.remove('hidden');w.classList.remove('revealed');});};
    
    load(1,'ar');
</script>
</body>
</html>
